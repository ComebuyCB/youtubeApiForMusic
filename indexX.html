<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.css" rel="stylesheet" >
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" >

    <link href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.css" rel="stylesheet" >
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.min.js"></script>

    <style>
        .plyr--youtube { aspect-ratio: 16/9; }
        button { margin-block: 1px; }
        .container { max-width: 800px; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-center-a { display: flex; align-items: center; }
        .text-more { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .text-more-3 { display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 3; overflow: hidden; }
    </style>
</head>
<body>
    <div class="container py-1 d-flex flex-column" style="max-width: 800px; max-height: 100vh;">
        <div class="navbar bg-light p-2">
            <button id="playListBtn" class="btn btn-dark" style="display: none;" data-bs-toggle="offcanvas" data-bs-target="#oc-playList">
                <i class="fa-solid fa-bars"></i>
            </button>
            <h5 id="playListTitle" class="text-center fw-bold mb-0" style="flex: 1 1 0"></h5>
            <button id="revokeTokenBtn" class="btn btn-secondary btn-sm" style="text-decoration: line-through;" onclick="revokeToken();">Token</button>
        </div>

        <div>
            <button id="getTokenBtn" class="btn btn-dark" onclick="loadYoutube_PlayLists();">Get Token & YouTube List</button>
        </div>

        <div id="oc-playList" class="offcanvas offcanvas-start" tabindex="-1">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title fw-bold" id="offcanvasExampleLabel">Youtube playList</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <div id="ownYouTubeList"></div> 
            </div>
        </div>

        <div id="playerBox">
            <video id="player"></video>
        </div>

        <div id="listItemsBlock" class="overflow-auto" style="flex: 1; display: none;">
            <div class="flex-center-a justify-content-between bg-light" style="position: sticky; top: 0; z-index: 1; height: 58px;">
                <button id="player_prev" class="btn btn-primary" tabindex><i class="fa fa-chevron-left"></i></button>
                <h6 id="listItemsTitle" class="text-center fw-bold mb-0 px-1 text-more-3" style="flex: 1 1 0"></h6>
                <button id="player_next" class="btn btn-primary" tabindex><i class="fa fa-chevron-right"></i></button>
            </div>
            <div id="listItems" class="pb-1"></div>
        </div>
    </div>

    <script>
        const myYTListId = 'PLHnudIi0nFjSNjQ14TkwCDqxV1R4dTp3d';
        const apiKey = 'AIzaSyAyydhCqIp6U9a7YajOyM2s9ydu_BDTi_I';
        const clientId = '17097823653-n8tqj92pn2d3o8ithbk7fq468s1ltba9.apps.googleusercontent.com';

        class createPlyr {
            constructor(){
                this.first = false;
                this.listIdx = 0;
                this.endStop = false;                
                let controlsPC = ['play', 'progress', 'current-time', 'duration', 'mute', 'volume']
                let controlsMobile = ['play', 'current-time', 'progress', 'duration', 'mute']
                this.player = new Plyr('#player', {
                    controls: ( window.orientation !== undefined ) ? controlsMobile : controlsPC, // 偵測是否 mobile
                })
                if ( window.orientation !== undefined ){
                    this.player.volume = 1.0;
                }
                this.resListItems = null;
                this.listItems = [];
                this.init();
            }

            importYTItems( resListItems ){
                this.resListItems = resListItems;
                this.listItems = resListItems.items.filter((e) => e.snippet.title !== "Private video" && e.snippet.title !== "Deleted video" )
                this.listIdx = 0;

                if ( this.listItems?.[0]?.id ){
                    $('#listItemsBlock').show();
                } else {
                    $('#listItemsBlock').hide();
                }

                this.loadTrack();
                this.showListItems();
            }

            showListItems(){
                let str = '';
                $.each( this.listItems, (idx, item)=>{
                    str += `
                    <button class="text-start btn btn-primary p-1 w-100 text-more" data-idx="${idx}">
                        <img src="${item?.snippet?.thumbnails?.default?.url}" style="width: 60px; aspect-ratio: 3/2; object-fit: contain;"> 
                        ${item.snippet.title}
                    </button>
                `
                })
                $('#listItems').html( str );
            }

            init(){
                this.listeners();
            }
            
            listeners(){
                let This = this
                This.player.on('play', function () {
                    console.log('play');
                })
                This.player.on('pause', function () {
                    console.log('pause');
                })
                This.player.on('ended', function () {
                    console.log('ended');
                    This.listIdx = ( This.listIdx + 1 < This.listItems.length ) ? This.listIdx + 1 : 0;
                    This.loadTrack();
                })
                This.player.on('ready', function(){
                    console.log('readyLoad');
                    if ( This.first === false ){
                        This.first = true;
                        return
                    }
                    This.player.play();
                    
                    $('#listItems').find('button').removeClass('active');
                    $('#listItems').find('button').eq(This.listIdx).addClass('active');
                })

                This.player.on('timeupdate', function(){
                    // console.log( This.player )
                })

                $(document).on('click', '#listItems [data-idx]', function(){
                    This.listIdx = +$(this).attr('data-idx');
                    This.loadTrack();
                })

                $(document).on('click', '#player_prev', function(){
                    This.listIdx = (This.listIdx > 0) ? This.listIdx - 1 : This.listItems.length - 1;
                    This.loadTrack();
                })

                $(document).on('click', '#player_next', function(){
                    This.listIdx = (This.listIdx + 1 < This.listItems.length) ? This.listIdx + 1 : 0;
                    This.loadTrack();
                })

                $(window).on('keydown',(e)=>{
                    if ( This.listItems ){
                        if ( e.key === 'ArrowLeft'){
                            This.player.currentTime -= 10
                        }
                        if ( e.key === 'ArrowRight'){
                            This.player.currentTime += 10
                        }
                        if ( e.key === ' '){
                            This.player.playing ? This.player.pause() : This.player.play()
                        }
                    }
                })

                navigator.mediaSession.setActionHandler('previoustrack', function() {
                    This.listIdx--;
                    This.loadTrack();
                });

                navigator.mediaSession.setActionHandler('nexttrack', function() {
                    This.listIdx--;
                    This.loadTrack();
                });

                let ii = 0;
                document.onvisibilitychange = function(){
                    navigator.mediaSession.metadata =  new MediaMetadata({
                        title: '音樂標題',
                        artist: '音樂作者',
                        album: '音樂專輯',
                        artwork: [ { src: 'https://picsum.photos/512', sizes: '512x512', type: 'image/png' } ]
                    });
                    navigator.mediaSession.setActionHandler('previoustrack', function() {
                        console.log('上一首播放邏輯')
                    });
                    navigator.mediaSession.setActionHandler('nexttrack', function() {
                        console.log('下一首播放邏輯')
                    });
                    console.log( ++ii )
                }
            }

            loadTrack(){
                let This = this;
                This.player.source = {
                    type: 'video',
                    sources: [{
                        src: This.listItems[This.listIdx].snippet.resourceId.videoId,
                        provider: 'youtube',
                    }],
                }
                $('#listItemsTitle').text( This.listItems[This.listIdx].snippet.title )
            }
        }

        let Player = new createPlyr();
        let client, client2;
        let access_token = getCookie('prevToken') || null;
        $(function(){
            initClient();
        })
        function initClient() {
            client = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/youtube.readonly',
                callback: (res) => {
                    console.log( res )
                    access_token = res.access_token;
                    setCookie('prevToken', access_token, res.expires_in );
                    loadYoutube_PlayLists();
                },
            });
            if ( access_token === null ){
                $('#getToken').addClass('btn-dark');
            }
        }
        function getToken() {
            client.requestAccessToken();
        }
        function revokeToken() {
            google.accounts.oauth2.revoke(access_token, () => {console.log('access token revoked')});
            $('#getTokenBtn').show();
        }
        function loadYoutube_PlayLists() {
            let url = `https://youtube.googleapis.com/youtube/v3/playlists?part=snippet%2CcontentDetails&maxResults=25&mine=true&key=${apiKey}`;
            $.ajax({
                url: url,
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                },
                success(res){
                    console.log('playLists: ', res);
                    let str = '';
                    $.each( res.items, (idx, item) => {
                        str += `<button class="btn btn-danger w-100" onclick="loadYoutube_ListItems('${item.id}'); $('#playListTitle').text('${item.snippet.title}'); $('#oc-playList').offcanvas('hide');">${item.snippet.title}</button>`
                    })
                    $('#ownYouTubeList').html(str);
                    $('#playListBtn').show();
                    $('#getTokenBtn').hide();
                },
                error(err){
                    console.log(err);
                    $('#playListBtn').hide();
                    $('#getTokenBtn').show();
                    getToken();
                }
            })
        }
        function loadYoutube_ListItems( ytListId) {
            let url = `https://youtube.googleapis.com/youtube/v3/playlistItems?part=snippet%2CcontentDetails&maxResults=25&playlistId=${ytListId}&key=${apiKey}`;
            $.ajax({
                url: url,
                type: 'GET',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + access_token);
                },
                success(res){
                    console.log('listItems: ', res);
                    Player.importYTItems(res);
                },
                error(err){
                    console.log(err);
                    $('#getTokenBtn').show();
                    alert('訪問失敗，可能是Token超時，請重新取得Token。')
                }
            })
        }


        /** 
         * 設置cookie
         * @param {string} name name
         * @param {string} value value
         * @param {boolean/number/string} expire 預設:false:不設定; true:10年; number:1(秒); String:"2030-01-01T00:00:00";
         * @param {string} valueType 若value是物件時，下'json' 將把value值先轉成字串再存入cookie。
         */
        function setCookie( name, value, expire, valueType ) {
            if ( valueType && valueType.toLowerCase() == "json" ){
                value = JSON.stringify(value);
            }
            var today = new Date();
            var expStr = "";
            if (expire){
                if (expire === true) {
                    today.setDate( 365*10 )
                    expStr = today.toGMTString()
                } else if ( typeof(expire) === 'number' ){
                    today.setTime( Math.floor( expire * 1000 + Date.now() ) )
                    console.log( today )
                    expStr = today.toGMTString()
                } else if ( typeof(expire) === 'string' ) {
                    expStr = new Date( expire ).toGMTString()
                } else {
                    alert( 'setCookie param Error!' )
                }
            }else{
                expStr = "Session";
            }
            document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expStr + ';path=/';
        }

        /**
         * 取得cookie
         * @param {string} name name
         * @param {string} valueType 若value是物件轉字串時，下'json'會把value值還原成物件。
         * @returns {string} 回傳 value
         */
        function getCookie( name, valueType ) {
            var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
            if (arr != null){
                if ( valueType && valueType.toLowerCase() == "json" ){
                    return JSON.parse( decodeURIComponent(arr[2]) );
                }
                return decodeURIComponent(arr[2]);
            }
            return null;
        }

        /** 
         * 刪除cookie 
         */
        function delCookie(name){
            let exp = new Date();
            let expStr = exp.toGMTString();
            document.cookie = name + '=;expires=' + expStr + ';path=/';
        }
    </script>
</body>
</html>